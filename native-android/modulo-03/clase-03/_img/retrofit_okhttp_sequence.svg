<?xml version="1.0" encoding="utf-8" ?>
<svg baseProfile="full" height="1100" version="1.1" width="1700" xmlns="http://www.w3.org/2000/svg" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xlink="http://www.w3.org/1999/xlink"><defs /><rect fill="white" height="1100" width="1700" x="0" y="0" /><text font-family="Inter, Arial, sans-serif" font-size="26" font-weight="bold" x="30" y="40">Retrofit ↔ OkHttp — Secuencia end‑to‑end (Compose + ViewModel)</text><text font-family="Inter, Arial, sans-serif" font-size="18" x="30" y="70">Diagrama de comunicación paso a paso (sin Mermaid)</text><g><rect fill="#f6f7f9" height="60" rx="12" ry="12" stroke="#cbd5e1" width="200" x="-10" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="90" y="77">Usuario</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="90" x2="90" y1="110" y2="1000" /></g><g><rect fill="#f6f7f9" height="60" rx="12" ry="12" stroke="#cbd5e1" width="200" x="210" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="310" y="77">Compose Screen</text><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="310" y="95">(UI)</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="310" x2="310" y1="110" y2="1000" /></g><g><rect fill="#f6f7f9" height="60" rx="12" ry="12" stroke="#cbd5e1" width="200" x="430" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="530" y="77">ViewModel</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="530" x2="530" y1="110" y2="1000" /></g><g><rect fill="#f6f7f9" height="60" rx="12" ry="12" stroke="#cbd5e1" width="200" x="650" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="750" y="77">Repository /</text><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="750" y="95">UseCase</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="750" x2="750" y1="110" y2="1000" /></g><g><rect fill="#f6f7f9" height="60" rx="12" ry="12" stroke="#cbd5e1" width="200" x="870" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="970" y="77">Retrofit</text><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="970" y="95">Service</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="970" x2="970" y1="110" y2="1000" /></g><g><rect fill="#f6f7f9" height="60" rx="12" ry="12" stroke="#cbd5e1" width="200" x="1090" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="1190" y="77">CallAdapter /</text><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="1190" y="95">Converter</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="1190" x2="1190" y1="110" y2="1000" /></g><g><rect fill="#f6f7f9" height="60" rx="12" ry="12" stroke="#cbd5e1" width="200" x="1310" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="1410" y="77">OkHttpClient</text><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="1410" y="95">+ Interceptors</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="1410" x2="1410" y1="110" y2="1000" /></g><g><rect fill="#f6f7f9" height="60" rx="12" ry="12" stroke="#cbd5e1" width="200" x="1530" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="15" font-weight="bold" text-anchor="middle" x="1630" y="77">API/Servidor</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="1630" x2="1630" y1="110" y2="1000" /></g><line stroke="#0f172a" stroke-width="2" x1="90" x2="310" y1="150" y2="150" /><polyline fill="#0f172a" points="310,150 302,144 302,156" /><circle cx="200.0" cy="132" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="200.0" y="136">1</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="200.0" y="124">Interacción (tap / pull‑to‑refresh / navegación)</text><line stroke="#0f172a" stroke-width="2" x1="310" x2="530" y1="202" y2="202" /><polyline fill="#0f172a" points="530,202 522,196 522,208" /><circle cx="420.0" cy="184" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="420.0" y="188">2</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="420.0" y="176">vm.loadProfile()</text><line stroke="#0f172a" stroke-width="2" x1="530" x2="750" y1="254" y2="254" /><polyline fill="#0f172a" points="750,254 742,248 742,260" /><circle cx="640.0" cy="236" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="640.0" y="240">3</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="640.0" y="228">getProfile()</text><line stroke="#0f172a" stroke-width="2" x1="750" x2="970" y1="306" y2="306" /><polyline fill="#0f172a" points="970,306 962,300 962,312" /><circle cx="860.0" cy="288" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="860.0" y="292">4</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="860.0" y="280">service.getProfile()</text><line stroke="#0f172a" stroke-width="2" x1="970" x2="1190" y1="358" y2="358" /><polyline fill="#0f172a" points="1190,358 1182,352 1182,364" /><circle cx="1080.0" cy="340" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1080.0" y="344">5</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1080.0" y="332">Construir Call + adaptar (suspend/Flow) + serializar</text><line stroke="#0f172a" stroke-width="2" x1="1190" x2="1410" y1="410" y2="410" /><polyline fill="#0f172a" points="1410,410 1402,404 1402,416" /><circle cx="1300.0" cy="392" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1300.0" y="396">6</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1300.0" y="384">execute(request)</text><line stroke="#0f172a" stroke-width="2" x1="1410" x2="1410" y1="462" y2="462" /><polyline fill="#0f172a" points="1410,462 1402,456 1402,468" /><circle cx="1410.0" cy="444" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1410.0" y="448">7</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1410.0" y="436">Chain: headers → auth → logging → network</text><line stroke="#0f172a" stroke-width="2" x1="1410" x2="1630" y1="514" y2="514" /><polyline fill="#0f172a" points="1630,514 1622,508 1622,520" /><circle cx="1520.0" cy="496" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1520.0" y="500">8</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1520.0" y="488">HTTP/2 + TLS → Enviar petición</text><line stroke="#0f172a" stroke-width="2" x1="1630" x2="1410" y1="566" y2="566" /><polyline fill="#0f172a" points="1410,566 1402,560 1402,572" /><circle cx="1520.0" cy="548" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1520.0" y="552">9</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1520.0" y="540">Respuesta HTTP (código + body)</text><line stroke="#0f172a" stroke-width="2" x1="1410" x2="1190" y1="618" y2="618" /><polyline fill="#0f172a" points="1190,618 1182,612 1182,624" /><circle cx="1300.0" cy="600" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1300.0" y="604">10</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1300.0" y="592">Devolver Response</text><line stroke="#0f172a" stroke-width="2" x1="1190" x2="750" y1="670" y2="670" /><polyline fill="#0f172a" points="750,670 742,664 742,676" /><circle cx="970.0" cy="652" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="970.0" y="656">11</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="970.0" y="644">Deserializar JSON → Model tipado</text><line stroke="#0f172a" stroke-width="2" x1="750" x2="530" y1="722" y2="722" /><polyline fill="#0f172a" points="530,722 522,716 522,728" /><circle cx="640.0" cy="704" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="640.0" y="708">12</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="640.0" y="696">Result&lt;Success|Error&gt; → DomainModel</text><line stroke="#0f172a" stroke-width="2" x1="530" x2="310" y1="774" y2="774" /><polyline fill="#0f172a" points="310,774 302,768 302,780" /><circle cx="420.0" cy="756" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="420.0" y="760">13</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="420.0" y="748">Emitir UiState via StateFlow/LiveData</text><line stroke="#0f172a" stroke-width="2" x1="310" x2="310" y1="826" y2="826" /><polyline fill="#0f172a" points="310,826 302,820 302,832" /><circle cx="310.0" cy="808" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="310.0" y="812">14</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="310.0" y="800">Recompose → Mostrar datos / error</text><text fill="#334155" font-family="Inter, Arial, sans-serif" font-size="14" x="30" y="446">Ruta opcional: Cache HIT (OkHttp Cache)</text><line stroke="#475569" stroke-width="2" x1="1410" x2="1410" y1="470" y2="470" /><polyline fill="#475569" points="1410,470 1402,464 1402,476" /><circle cx="1410.0" cy="452" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1410.0" y="456">15</text><text fill="#475569" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1410.0" y="444">Cache válida → responde sin red</text><text fill="#334155" font-family="Inter, Arial, sans-serif" font-size="14" x="30" y="540">Ruta opcional: 401 Unauthorized + Authenticator (refresh token)</text><path d="M1410,570 Q970.0,535 530,570" fill="none" stroke="#7c2d12" stroke-width="2" /><polyline fill="#7c2d12" points="530,570 522,564 522,576" /><circle cx="970.0" cy="552" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="970.0" y="556">16</text><text fill="#7c2d12" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="970.0" y="544">Solicitar refresh token seguro</text><path d="M530,610 Q1080.0,575 1630,610" fill="none" stroke="#7c2d12" stroke-width="2" /><polyline fill="#7c2d12" points="1630,610 1622,604 1622,616" /><circle cx="1080.0" cy="592" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1080.0" y="596">17</text><text fill="#7c2d12" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1080.0" y="584">POST /auth/refresh</text><path d="M1630,650 Q1520.0,615 1410,650" fill="none" stroke="#7c2d12" stroke-width="2" /><polyline fill="#7c2d12" points="1410,650 1402,644 1402,656" /><circle cx="1520.0" cy="632" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1520.0" y="636">18</text><text fill="#7c2d12" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1520.0" y="624">200 OK (nuevo access token)</text><path d="M1410,690 Q1520.0,655 1630,690" fill="none" stroke="#7c2d12" stroke-width="2" /><polyline fill="#7c2d12" points="1630,690 1622,684 1622,696" /><circle cx="1520.0" cy="672" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1520.0" y="676">19</text><text fill="#7c2d12" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1520.0" y="664">Reintentar petición original</text><path d="M1630,730 Q1520.0,695 1410,730" fill="none" stroke="#7c2d12" stroke-width="2" /><polyline fill="#7c2d12" points="1410,730 1402,724 1402,736" /><circle cx="1520.0" cy="712" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1520.0" y="716">20</text><text fill="#7c2d12" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1520.0" y="704">200 OK (respuesta final)</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="30" y="960">Notas clave:</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="30" y="980">• Interceptors (orden sugerido): headers → auth → logging (debug) → network (cache).</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="30" y="1000">• Evitar bucles en Authenticator: no reintentar si el refresh falló o ya se usó un token nuevo.</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="30" y="1020">• UiState en ViewModel: sealed class (Loading / Success(data) / Error(message)).</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="30" y="1040">• Compose colecta StateFlow con collectAsState() y recompone al cambiar el estado.</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="30" y="1060">• Configurar timeouts, ConnectionPool y política de cache en OkHttp según carga.</text></svg>