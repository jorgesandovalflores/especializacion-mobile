<?xml version="1.0" encoding="utf-8" ?>
<svg baseProfile="full" height="1900" version="1.1" width="2200" xmlns="http://www.w3.org/2000/svg" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xlink="http://www.w3.org/1999/xlink"><defs /><rect fill="white" height="1900" width="2200" x="0" y="0" /><text font-family="Inter, Arial, sans-serif" font-size="28" font-weight="bold" x="30" y="40">Flujo de Refresh Token — OkHttp Authenticator + ViewModel + TokenStore (Layout notas corregido)</text><text font-family="Inter, Arial, sans-serif" font-size="18" x="30" y="72">Secuencia ante 401 con de-duplicación, rama de fallo y actualización de UiState (SVG)</text><rect fill="#f1f5f9" height="72" rx="12" ry="12" stroke="#cbd5e1" width="260" x="20" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="150" y="74">Compose UI</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="150" x2="150" y1="120" y2="1420" /><rect fill="#f1f5f9" height="72" rx="12" ry="12" stroke="#cbd5e1" width="260" x="300" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="430" y="74">ViewModel</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="430" x2="430" y1="120" y2="1420" /><rect fill="#f1f5f9" height="72" rx="12" ry="12" stroke="#cbd5e1" width="260" x="580" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="710" y="74">TokenStore</text><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="710" y="94">(Seguro)</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="710" x2="710" y1="120" y2="1420" /><rect fill="#f1f5f9" height="72" rx="12" ry="12" stroke="#cbd5e1" width="260" x="860" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="990" y="74">Repository /</text><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="990" y="94">UseCase</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="990" x2="990" y1="120" y2="1420" /><rect fill="#f1f5f9" height="72" rx="12" ry="12" stroke="#cbd5e1" width="260" x="1140" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="1270" y="74">OkHttpClient</text><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="1270" y="94">(Interceptors)</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="1270" x2="1270" y1="120" y2="1420" /><rect fill="#f1f5f9" height="72" rx="12" ry="12" stroke="#cbd5e1" width="260" x="1420" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="1550" y="74">Authenticator</text><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="1550" y="94">(401 Handler)</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="1550" x2="1550" y1="120" y2="1420" /><rect fill="#f1f5f9" height="72" rx="12" ry="12" stroke="#cbd5e1" width="260" x="1700" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="1830" y="74">/auth/refresh</text><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="1830" y="94">(Auth API)</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="1830" x2="1830" y1="120" y2="1420" /><rect fill="#f1f5f9" height="72" rx="12" ry="12" stroke="#cbd5e1" width="260" x="1980" y="50" /><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="2110" y="74">API destino</text><text font-family="Inter, Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" x="2110" y="94">(original)</text><line stroke="#94a3b8" stroke-dasharray="6,6" x1="2110" x2="2110" y1="120" y2="1420" /><line stroke="#0f172a" stroke-width="2" x1="150" x2="430" y1="170" y2="170" /><polyline fill="#0f172a" points="430,170 421,163 421,177" /><circle cx="290.0" cy="146" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="290.0" y="150">1</text><rect fill="#ffffff" height="40" rx="8" ry="8" stroke="#e2e8f0" width="365.5" x="107.25" y="100" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="290.0" y="118">Acción del usuario: vm.fetch() / navegación a</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="290.0" y="136">pantalla</text><line stroke="#0f172a" stroke-width="2" x1="430" x2="990" y1="250" y2="250" /><polyline fill="#0f172a" points="990,250 981,243 981,257" /><circle cx="710.0" cy="226" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="710.0" y="230">2</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="178.0" x="621.0" y="198" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="710.0" y="216">Repository.getData()</text><line stroke="#0f172a" stroke-width="2" x1="990" x2="1270" y1="330" y2="330" /><polyline fill="#0f172a" points="1270,330 1261,323 1261,337" /><circle cx="1130.0" cy="306" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1130.0" y="310">3</text><rect fill="#ffffff" height="40" rx="8" ry="8" stroke="#e2e8f0" width="343.0" x="958.5" y="260" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1130.0" y="278">Request con Authorization: Bearer (posible</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1130.0" y="296">expirado)</text><line stroke="#0f172a" stroke-width="2" x1="1270" x2="2110" y1="410" y2="410" /><polyline fill="#0f172a" points="2110,410 2101,403 2101,417" /><circle cx="1690.0" cy="386" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1690.0" y="390">4</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="238.0" x="1571.0" y="358" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1690.0" y="376">Enviar petición HTTP/2 + TLS</text><line stroke="#b91c1c" stroke-width="2" x1="2110" x2="1270" y1="490" y2="490" /><polyline fill="#b91c1c" points="1270,490 1261,483 1261,497" /><circle cx="1690.0" cy="466" fill="#b91c1c" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1690.0" y="470">5</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="148.0" x="1616.0" y="438" /><text fill="#b91c1c" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1690.0" y="456">401 Unauthorized</text><line stroke="#0f172a" stroke-width="2" x1="1270" x2="1550" y1="570" y2="570" /><polyline fill="#0f172a" points="1550,570 1541,563 1541,577" /><circle cx="1410.0" cy="546" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1410.0" y="550">6</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="320.5" x="1249.75" y="518" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1410.0" y="536">Disparar Authenticator (onResponse 401)</text><line stroke="#0f172a" stroke-width="2" x1="1550" x2="710" y1="650" y2="650" /><polyline fill="#0f172a" points="710,650 701,643 701,657" /><circle cx="1130.0" cy="626" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1130.0" y="630">7</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="283.0" x="988.5" y="598" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1130.0" y="616">¿isRefreshing? (mutex) → comprobar</text><line stroke="#0f172a" stroke-width="2" x1="710" x2="1550" y1="730" y2="730" /><polyline fill="#0f172a" points="1550,730 1541,723 1541,737" /><circle cx="1130.0" cy="706" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1130.0" y="710">8</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="373.0" x="943.5" y="678" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1130.0" y="696">No: adquirir lock y continuar flujo de refresh</text><line stroke="#0f172a" stroke-width="2" x1="1550" x2="430" y1="810" y2="810" /><polyline fill="#0f172a" points="430,810 421,803 421,817" /><circle cx="990.0" cy="786" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="990.0" y="790">9</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="350.5" x="814.75" y="758" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="990.0" y="776">Solicitar refresh token seguro al ViewModel</text><line stroke="#0f172a" stroke-width="2" x1="430" x2="710" y1="890" y2="890" /><polyline fill="#0f172a" points="710,890 701,883 701,897" /><circle cx="570.0" cy="866" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="570.0" y="870">10</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="380.5" x="379.75" y="838" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="570.0" y="856">Obtener refresh (EncryptedSharedPrefs/Keystore)</text><line stroke="#0f172a" stroke-width="2" x1="710" x2="1550" y1="970" y2="970" /><polyline fill="#0f172a" points="1550,970 1541,963 1541,977" /><circle cx="1130.0" cy="946" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1130.0" y="950">11</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="320.5" x="969.75" y="918" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1130.0" y="936">Entregar refresh token al Authenticator</text><line stroke="#0f172a" stroke-width="2" x1="1550" x2="1830" y1="1050" y2="1050" /><polyline fill="#0f172a" points="1830,1050 1821,1043 1821,1057" /><circle cx="1690.0" cy="1026" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1690.0" y="1030">12</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="163.0" x="1608.5" y="998" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1690.0" y="1016">POST /auth/refresh</text><line stroke="#166534" stroke-width="2" x1="1830" x2="1550" y1="1130" y2="1130" /><polyline fill="#166534" points="1550,1130 1541,1123 1541,1137" /><circle cx="1690.0" cy="1106" fill="#166534" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1690.0" y="1110">13</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="275.5" x="1552.25" y="1078" /><text fill="#166534" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1690.0" y="1096">200 OK → nuevo access (+refresh?)</text><line stroke="#0f172a" stroke-width="2" x1="1550" x2="710" y1="1210" y2="1210" /><polyline fill="#0f172a" points="710,1210 701,1203 701,1217" /><circle cx="1130.0" cy="1186" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1130.0" y="1190">14</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="268.0" x="996.0" y="1158" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1130.0" y="1176">Actualizar tokens y liberar lock</text><line stroke="#0f172a" stroke-width="2" x1="1550" x2="1270" y1="1290" y2="1290" /><polyline fill="#0f172a" points="1270,1290 1261,1283 1261,1297" /><circle cx="1410.0" cy="1266" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1410.0" y="1270">15</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="365.5" x="1227.25" y="1238" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1410.0" y="1256">Reintentar petición original con Bearer nuevo</text><line stroke="#0f172a" stroke-width="2" x1="1270" x2="2110" y1="1370" y2="1370" /><polyline fill="#0f172a" points="2110,1370 2101,1363 2101,1377" /><circle cx="1690.0" cy="1346" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1690.0" y="1350">16</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="155.5" x="1612.25" y="1318" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1690.0" y="1336">Reenviar petición</text><line stroke="#166534" stroke-width="2" x1="2110" x2="1270" y1="1450" y2="1450" /><polyline fill="#166534" points="1270,1450 1261,1443 1261,1457" /><circle cx="1690.0" cy="1426" fill="#166534" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1690.0" y="1430">17</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="208.0" x="1586.0" y="1398" /><text fill="#166534" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1690.0" y="1416">200 OK (respuesta final)</text><line stroke="#0f172a" stroke-width="2" x1="1270" x2="990" y1="1530" y2="1530" /><polyline fill="#0f172a" points="990,1530 981,1523 981,1537" /><circle cx="1130.0" cy="1506" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1130.0" y="1510">18</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="260.5" x="999.75" y="1478" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1130.0" y="1496">Devolver Response al Repository</text><line stroke="#0f172a" stroke-width="2" x1="990" x2="430" y1="1610" y2="1610" /><polyline fill="#0f172a" points="430,1610 421,1603 421,1617" /><circle cx="710.0" cy="1586" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="710.0" y="1590">19</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="298.0" x="561.0" y="1558" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="710.0" y="1576">DomainModel/Result → UiState.Success</text><line stroke="#0f172a" stroke-width="2" x1="430" x2="150" y1="1690" y2="1690" /><polyline fill="#0f172a" points="150,1690 141,1683 141,1697" /><circle cx="290.0" cy="1666" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="290.0" y="1670">20</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="223.0" x="178.5" y="1638" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="290.0" y="1656">Emitir UiState → Recompose</text><text fill="#334155" font-family="Inter, Arial, sans-serif" font-size="15" x="30" y="814">Colas concurrentes esperando durante isRefreshing=true (de-duplicación de /refresh)</text><line stroke="#b91c1c" stroke-width="2" x1="1270" x2="1550" y1="840" y2="840" /><polyline fill="#b91c1c" points="1550,840 1541,833 1541,847" /><circle cx="1410.0" cy="816" fill="#b91c1c" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1410.0" y="820">21</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="208.0" x="1306.0" y="788" /><text fill="#b91c1c" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1410.0" y="806">Otra petición recibe 401</text><line stroke="#0f172a" stroke-dasharray="8,8" stroke-width="2" x1="1550" x2="710" y1="920" y2="920" /><polyline fill="#0f172a" points="710,920 701,913 701,927" /><circle cx="1130.0" cy="896" fill="#0f172a" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1130.0" y="900">22</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="275.5" x="992.25" y="868" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1130.0" y="886">isRefreshing? → Sí: esperar señal</text><line stroke="#166534" stroke-width="2" x1="710" x2="1550" y1="1000" y2="1000" /><polyline fill="#166534" points="1550,1000 1541,993 1541,1007" /><circle cx="1130.0" cy="976" fill="#166534" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1130.0" y="980">23</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="230.5" x="1014.75" y="948" /><text fill="#166534" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1130.0" y="966">onTokensUpdated → continuar</text><line stroke="#166534" stroke-width="2" x1="1550" x2="1270" y1="1080" y2="1080" /><polyline fill="#166534" points="1270,1080 1261,1073 1261,1087" /><circle cx="1410.0" cy="1056" fill="#166534" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1410.0" y="1060">24</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="230.5" x="1294.75" y="1028" /><text fill="#166534" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1410.0" y="1046">Reintentar con Bearer nuevo</text><text fill="#334155" font-family="Inter, Arial, sans-serif" font-size="15" x="30" y="1134">Rama de fallo de refresh (invalid_grant/401/400) → limpiar sesión y forzar login</text><line stroke="#b91c1c" stroke-width="2" x1="1550" x2="1830" y1="1160" y2="1160" /><polyline fill="#b91c1c" points="1830,1160 1821,1153 1821,1167" /><circle cx="1690.0" cy="1136" fill="#b91c1c" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1690.0" y="1140">25</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="163.0" x="1608.5" y="1108" /><text fill="#b91c1c" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1690.0" y="1126">POST /auth/refresh</text><line stroke="#b91c1c" stroke-width="2" x1="1830" x2="1550" y1="1240" y2="1240" /><polyline fill="#b91c1c" points="1550,1240 1541,1233 1541,1247" /><circle cx="1690.0" cy="1216" fill="#b91c1c" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1690.0" y="1220">26</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="223.0" x="1578.5" y="1188" /><text fill="#b91c1c" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1690.0" y="1206">401/400 → refresh inválido</text><line stroke="#b91c1c" stroke-width="2" x1="1550" x2="710" y1="1320" y2="1320" /><polyline fill="#b91c1c" points="710,1320 701,1313 701,1327" /><circle cx="1130.0" cy="1296" fill="#b91c1c" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1130.0" y="1300">27</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="245.5" x="1007.25" y="1268" /><text fill="#b91c1c" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1130.0" y="1286">Limpiar tokens + liberar lock</text><line stroke="#b91c1c" stroke-width="2" x1="1550" x2="1270" y1="1400" y2="1400" /><polyline fill="#b91c1c" points="1270,1400 1261,1393 1261,1407" /><circle cx="1410.0" cy="1376" fill="#b91c1c" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="1410.0" y="1380">28</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="305.5" x="1257.25" y="1348" /><text fill="#b91c1c" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="1410.0" y="1366">No reintentar; devolver 401 al caller</text><line stroke="#b91c1c" stroke-width="2" x1="1270" x2="430" y1="1480" y2="1480" /><polyline fill="#b91c1c" points="430,1480 421,1473 421,1487" /><circle cx="850.0" cy="1456" fill="#b91c1c" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="850.0" y="1460">29</text><rect fill="#ffffff" height="22" rx="8" ry="8" stroke="#e2e8f0" width="193.0" x="753.5" y="1428" /><text fill="#b91c1c" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="850.0" y="1446">Notificar Unauthorized</text><line stroke="#b91c1c" stroke-width="2" x1="430" x2="150" y1="1560" y2="1560" /><polyline fill="#b91c1c" points="150,1560 141,1553 141,1567" /><circle cx="290.0" cy="1536" fill="#b91c1c" r="12" /><text fill="white" font-family="Inter, Arial, sans-serif" font-size="12" text-anchor="middle" x="290.0" y="1540">30</text><rect fill="#ffffff" height="40" rx="8" ry="8" stroke="#e2e8f0" width="320.5" x="129.75" y="1490" /><text fill="#b91c1c" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="290.0" y="1508">UiState.Error → navegar a Login / pedir</text><text fill="#b91c1c" font-family="Inter, Arial, sans-serif" font-size="14" text-anchor="middle" x="290.0" y="1526">re‑autenticación</text><rect fill="#f8fafc" height="380" rx="16" ry="16" stroke="#cbd5e1" width="2140" x="30" y="1470" /><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="18" font-weight="bold" x="50" y="1510">Notas (sin recortar información)</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="50" y="1550">• TokenStore seguro: EncryptedSharedPreferences +</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="72" y="1572">MasterKey/Keystore.</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="50" y="1600">• Mutex isRefreshing: evita múltiples /refresh simultáneos;</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="72" y="1622">otras llamadas esperan el evento de actualización.</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="50" y="1650">• Interceptors: gestionan Authorization; Authenticator sólo</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="72" y="1672">reintenta si el refresh fue exitoso.</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="1110.0" y="1550">• Evitar loops: si el refresh falla → limpiar sesión y exigir</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="1132.0" y="1572">login.</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="1110.0" y="1600">• ViewModel emite UiState; Compose usa collectAsState() para</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="1132.0" y="1622">recomponer.</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="1110.0" y="1650">• Opcional: emitir evento onTokensUpdated para que otras capas</text><text fill="#0f172a" font-family="Inter, Arial, sans-serif" font-size="14" x="1132.0" y="1672">renueven credenciales en memoria.</text></svg>